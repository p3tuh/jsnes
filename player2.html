<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
     <link rel="stylesheet" href="style.css">
</head>
  
<body>
    <!-- <div class="pure-u-2-3" id="video-container">
      <video id="their-video" autoplay></video>
      <video id="my-video" muted="true" autoplay></video>
    </div>
     -->
    <div id="emulator" style="float: left"></div>
    <div class="pure-g">

        <!-- Video area -->
        <div class="pure-u-2-3" id="video-container">
          <video id="their-video" autoplay></video>
        </div>

        <!-- Steps -->
        <div class="pure-u-1-3">
          <h2>PeerJS Video Chat</h2>

          <!-- Get local audio/video stream -->
          <div id="step1">
            <p>Please click `allow` on the top of the screen so we can access your webcam and microphone for calls.</p>
            <div id="step1-error">
              <p>Failed to access the webcam and microphone. Make sure to run this demo on an http server and click allow when asked for permission by the browser.</p>
              <a href="#" class="pure-button pure-button-error" id="step1-retry">Try again</a>
            </div>
          </div>

          <!-- Make calls to others -->
          <div id="step2">
            <p>Your id: <span id="my-id">...</span></p>
            <p>Share this id with others so they can call you.</p>
            <h3>Make a call</h3>
            <div class="pure-form">
              <input type="text" placeholder="Call user id..." id="callto-id">
              <a href="#" class="pure-button pure-button-success" id="make-call">Call</a>
            </div>
          </div>

          <!-- Call in progress -->
          <div id="step3">
            <p>Currently in call with <span id="their-id">...</span></p>
            <p><a href="#" class="pure-button pure-button-error" id="end-call">End call</a></p>
          </div>
        </div>
    </div>


    <a href='localhost:8000/player2.html?8596'> URL </a>
    <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="lib/dynamicaudio-min.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/nes.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/utils.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/cpu.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/keyboard.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/mappers.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/papu.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/ppu.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/rom.js" type="text/javascript" charset="utf-8"></script>
    <script src="source/ui.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript" charset="utf-8">

    var rtcId = location.search.slice(1);
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

// Establish PeerJs connection
    var peer = new Peer('player2' + rtcId, {key: 'j994bvub6smdkj4i', debug: 3});

// Connect to your game
    peer.on('open', function (){
      var c = peer.connect(rtcId);

      c.on('open', function (data) {
        console.log('hello peter');

      });

        //sending keydown 
      $("body").keydown(function(e) {
        console.log('keydown ' + e.which);
        
        var stroke = {type: 'keydown', which: e.which};

        c.send(stroke);
      });
        //sending keyup
      $('body').keyup(function(e) {
        console.log('keyup ' + e.which);
        var stroke = {type: 'keyup', which: e.which};

        c.send(stroke);
      });

        //on click of restart, send restart method to other player
      $( ".nes-restart" ).click(function() {
        c.send({method: 'restart'});
      });
        //on click of pause, send pause method to other player
      $( ".nes-pause" ).click(function() {
        c.send({method: 'pause'});
      });

      c.on('data', function(data) {
        console.log(data);
        var convertedKey = keyPress[data.which];
        console.log(convertedKey);
        if (data.type === 'keyup') {
          nes.keyboard.keyUp({keyCode: convertedKey});
          // nes.frame();
        }
        if (data.type === 'keydown') {
          nes.keyboard.keyDown({keyCode: convertedKey});
          // nes.frame();
        }
          //Restart if other player clicks restart
        // if (data.method === 'restart') {
        //   $('.nes-restart').trigger('click');
        // }
        //   //pause if other player clicks pause
        // if (data.method === 'pause') {
        //   $('.nes-pause').trigger('click');
        // }
        
      });

    });

    // video calls
    peer.on('open', function(){
      $('#my-id').text(peer.id);
    });

    // Receiving a call
    peer.on('call', function(call){
      // Answer the call automatically (instead of prompting user) for demo purposes
      call.answer(window.localStream);
      console.log('localStream: ' + window.localStream);
      step3(call);
    });
    peer.on('error', function(err){
      alert(err.message);
      // Return to step 2 if error occurs
      step2();
    });

    // Click handlers setup
    $(function(){
      $('#make-call').click(function(){
        // Initiate a call!
        var call = peer.call($('#callto-id').val(), window.localStream);

        step3(call);
      });

      $('#end-call').click(function(){
        window.existingCall.close();
        step2();
      });

      // Retry if getUserMedia fails
      $('#step1-retry').click(function(){
        $('#step1-error').hide();
        step1();
      });

      // Get things started
      step1();
    });

    function step1 () {
      // Get audio/video stream
      navigator.getUserMedia({audio: false, video: true}, function(stream){
        // Set your video displays
        $('#my-video').prop('src', URL.createObjectURL(stream));

        window.localStream = stream;
        step2();
      }, function(){ $('#step1-error').show(); });
    }

    function step2 () {
      $('#step1, #step3').hide();
      $('#step2').show();
    }

    function step3 (call) {
      // Hang up on an existing call if present
      if (window.existingCall) {
        window.existingCall.close();
      }

      // Wait for stream on the call, then set peer video display
      call.on('stream', function(stream){
        $('#their-video').prop('src', URL.createObjectURL(stream));
      });

      // UI stuff
      window.existingCall = call;
      $('#their-id').text(call.peer);
      call.on('close', step2);
      $('#step1, #step2').hide();
      $('#step3').show();
    }

      var keyPress = { 
        37: 100,
        38: 104,
        39: 102,
        40: 98,
        88: 103,
        90: 105,
        13: 97,
        17: 99
      };

        var nes;
        $(function() {
            nes = new JSNES({
                'ui': $('#emulator').JSNESUI({
                    "Homebrew": [
                        ['Concentration Room', 'roms/croom/croom.nes'],
                        ['LJ65', 'roms/lj65/lj65.nes'],
                    ],
                    "Working": [
                        ['Bubble Bobble', 'local-roms/Bubble Bobble (U).nes'],
                        
                        ['Contra', 'roms/contra/Contra.nes'],
                        ['Donkey Kong', 'local-roms/Donkey Kong (JU).nes'],
                        ['Dr. Mario', 'local-roms/Dr. Mario (JU).nes'],
                        ['Golf', 'local-roms/Golf (JU).nes'],
                        ['The Legend of Zelda', 'local-roms/Legend of Zelda, The (U) (PRG1).nes'],
                        ['Lemmings', 'local-roms/Lemmings (U).nes'],
                        ['Lifeforce', 'local-roms/Lifeforce (U).nes'],
                        
                        ['Mario Bros.', 'local-roms/Mario Bros. (JU) [!].nes'],
                        ['Mega Man', 'local-roms/Mega Man (U).nes'],
                        ['Pac-Man', 'local-roms/Pac-Man (U) [!].nes'],
                        ['Super Mario Bros.', 'local-roms/Super Mario Bros. (JU) (PRG0) [!].nes'],
                        ['Tennis', 'local-roms/Tennis (JU) [!].nes'],
                        ['Tetris', 'local-roms/Tetris (U) [!].nes'],
                        ['Tetris 2', 'local-roms/Tetris 2 (U) [!].nes'],
                        ['Zelda II - The Adventure of Link', 'local-roms/Zelda II - The Adventure of Link (U).nes']
                    ],

                    "Nearly Working": [
                        ['Duck Hunt', 'local-roms/Duck Hunt (JUE) [!].nes'],
                        ['Super Mario Bros. 3', 'local-roms/Super Mario Bros. 3 (U) (PRG1) [!].nes']
                    ]
                })
            });
        });
    </script>
    <!--[if IE]>
        <script type="text/vbscript" src="source/jsnes-ie-hacks.vbscript"></script>
    <![endif]-->

</body>
</html>
